---
title: "Response to Burns et al"
author: "Travis Gerke, Konrad Stopsack"
date: '`r strftime(Sys.time(), "%A, %b %d, %Y")`'
mainfont: 'Source Serif Pro'
monofont: 'Source Code Pro'
output:
  rmarkdown::html_vignette:
    df_print: kable
    standalone: true
  pdf_document: 
    latex_engine: xelatex
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, cache = FALSE,
  warning = FALSE, message = FALSE,
  fig.width = 10, fig.height = 7, 
  fig.showtext = TRUE # for the fancy fonts, disable if not needed
)
```

```{css global-css, echo=FALSE}
img {
  margin: 0;
  padding: 0;
  max-width: 100%;
}
```

```{r library, include=FALSE}
library(tidyverse)
library(popEpi)  # for use of sir()

# Use the grkmisc theme
theme_set(
  grkmisc::theme_grk(
    base_family = "Source Serif Pro",
    axis_text_family = "Source Code Pro",
    axis_title_family = "Source Serif Pro",
    default_geom_font = "Source Sans Pro",
    use_showtext = TRUE
  ) + 
    theme(panel.grid.minor = element_blank())
)
```
   
```{r load, include=FALSE}
# Load Data

# CDC United States Cancer Statistics 1999-2015 from 
# https://www.cdc.gov/cancer/uscs/USCS_1999_2015_ASCII.zip via
# https://www.cdc.gov/cancer/uscs/dataviz/download_data.htm
uscs <- read_delim(file = "data/BYAGE.TXT", delim = "|", guess_max = 250000)

# Use 2014 incidence rates (end of inclusion in Burns et al.)
uscs <- uscs %>% 
  rename_all(tolower) %>%
  filter(site == "Prostate" & sex == "Male" & year == "2014" &
                   event_type == "Incidence" & race == "All Races" & rate != "~") %>%
  mutate(agestart = as.numeric(str_sub(age, 1, 2)), 
         count = as.numeric(count))

# Input Burns et al., Eur Urol 2018, Table 1 counts
burns <- tibble(decade     = rep(c(30, 40, 50, 60, 70), 2), # Start of age category
                    n      = c(630, 2602, 3304, 1978, 792, 70, 288, 366, 221, 47), # Person counts 
                    cases  = c(29, rep(NA, 4), 30, rep(NA, 4)), # 5-yr cumulative incidence of total PCa
                    group  = as.factor(c(rep("Non-IBD", 5), rep("IBD", 5))))

# Split counts equally into 5-year age categories instead of 10-year age categories to match the standard population
burnsStd <- burns %>% uncount(2, .id = "duplicate") %>%
  mutate(agestart = if_else(duplicate == 1, decade, decade + 5),
         n_fu     = n * 5 / 2) %>%  # Table 1 gives 5-year cumulative incidence. Put half into each 5-year category
  filter(!(decade == 30 & duplicate == 1))  # Assign "<40" counts to 35-40 age band only (also, no rates for <35 in std. pop)

# SMRs for IBD and non-IBD groups compared to U.S. population
results <- sir(coh.data = burnsStd,       # Exposed: dataset
    coh.obs  = cases,       # Exposed: Case count (note--total cases per "group" listed in one random stratum of age)
    coh.pyrs = n_fu,        # Exposed: Person-time
    ref.data = uscs,        # Standard: dataset
    ref.obs  = count,       # Standard: Case count
    ref.pyrs = population,  # Standard: Person-time (time presumed to be one year)
    print    = group,       # Exposed: IBD vs. non-IBD
    adjust   = agestart)    # Strata, must be same variable in exposed and standard
```

<!-- Start Document Here -->